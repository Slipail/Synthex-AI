<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>SynthEx AI</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='url(%23g)'/><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300f0c0'/><stop offset='1' stop-color='%23a78bfa'/></linearGradient></defs><text x='50' y='68' text-anchor='middle' font-family='monospace' font-weight='bold' font-size='40' fill='%230a0e17'>SX</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// Firebase config - you'll need to create a Firebase project and paste config here
// Go to console.firebase.google.com -> Create project -> Firestore Database -> Create
// Then Project settings -> Add web app -> Copy config
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDb6o7oaNZhofoto_3FRKv-R1hjetzANw-B",
  authDomain: "synthex-ai.firebaseapp.com",
  projectId: "synthex-ai",
  storageBucket: "synthex-ai.firebasestorage.app",
  messagingSenderId: "540857759802",
  appId: "1:540857759802:web:588ee46371eda1b553f103",
  measurementId: "G-MY7QELGoYF"
};
let db = null;
if (FIREBASE_CONFIG.apiKey) {
  firebase.initializeApp(FIREBASE_CONFIG);
  db = firebase.firestore();
}
</script>
<style>
*{box-sizing:border-box;margin:0;padding:0}html,body,#root{height:100%;overflow:hidden;position:fixed;width:100%;top:0;left:0}
body{background:#0a0e17;color:#e2e8f0;font-family:'Outfit','Segoe UI',sans-serif;-webkit-text-size-adjust:100%}
input,textarea,button{font-size:16px}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(100,116,139,.2);border-radius:10px}
*{scrollbar-width:thin;scrollbar-color:rgba(100,116,139,.2) transparent}
textarea::-webkit-scrollbar{width:4px}textarea::-webkit-scrollbar-thumb{background:rgba(100,116,139,.15);border-radius:10px}
.gridbg{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(0,240,192,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,240,192,.03) 1px,transparent 1px);background-size:60px 60px;-webkit-mask-image:radial-gradient(ellipse 80% 70% at 50% 30%,#000 20%,transparent 70%)}
.gorb{position:fixed;border-radius:50%;filter:blur(100px);opacity:.12;z-index:0;pointer-events:none}
@keyframes of{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(30px,-40px) scale(1.1)}66%{transform:translate(-20px,30px) scale(.9)}}
@keyframes mi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes wp{0%,100%{box-shadow:0 0 30px #00f0c030,0 0 60px #00f0c015}50%{box-shadow:0 0 50px #00f0c050,0 0 80px #00f0c025}}
@keyframes dotB{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-4px);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.mc h1{font-size:18px;font-weight:700;margin:12px 0 6px}.mc h2{font-size:16px;font-weight:700;margin:12px 0 6px}.mc h3{font-size:14px;font-weight:700;margin:10px 0 4px}
.mc p{margin-bottom:8px;line-height:1.7}.mc p:last-child{margin-bottom:0}.mc strong{color:#00f0c0;font-weight:600}.mc em{color:#94a3b8}
.mc a{color:#00f0c0;text-decoration:underline;cursor:pointer}.mc a:hover{color:#34d399}
.mc pre{background:#0a0e17;border:1px solid #1e293b;border-radius:8px;padding:14px;margin:10px 0;overflow-x:auto;overflow-y:auto;max-height:300px;position:relative;font-family:'JetBrains Mono',monospace;font-size:12.5px}
.gen-status{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px;color:#94a3b8}
.gen-spinner{width:14px;height:14px;border-radius:50%;border:2px solid #00f0c0;border-top-color:transparent;animation:spin .8s linear infinite;flex-shrink:0}
.gen-done{color:#00f0c0;font-size:14px;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.mc code{font-family:'JetBrains Mono',monospace;font-size:12.5px}.mc .ic{background:#1e293b;padding:2px 6px;border-radius:4px;font-size:12px;color:#00f0c0}
.mc ul,.mc ol{margin:8px 0;padding-left:24px;list-style-position:inside}.mc ul{list-style-type:disc}.mc ol{list-style-type:decimal}.mc li{margin-bottom:4px;line-height:1.6;padding-left:4px}
.mc blockquote{border-left:3px solid rgba(0,240,192,.25);padding-left:12px;color:#94a3b8;margin:8px 0}
.cpb{position:absolute;top:8px;right:8px;background:#1e293b;border:1px solid #334155;border-radius:6px;color:#64748b;cursor:pointer;padding:3px 8px;font-size:11px;font-family:'JetBrains Mono',monospace;transition:.15s}.cpb:hover{color:#00f0c0}
.itx:focus{border-color:rgba(0,240,192,.25)!important;box-shadow:0 0 0 3px rgba(0,240,192,.06),0 0 20px rgba(0,240,192,.12)}
.sug:hover{border-color:rgba(0,240,192,.25)!important;transform:translateY(-1px);background:#111d30!important}
.ci:hover{background:rgba(30,41,59,.3)}.mo:hover{background:rgba(30,41,59,.3)}
.ncb:hover{background:linear-gradient(135deg,rgba(0,240,192,.1),rgba(167,139,250,.06))!important;border-color:rgba(0,240,192,.3)!important}
.sndb:hover:not(:disabled){box-shadow:0 0 25px rgba(0,240,192,.3);transform:scale(1.05)}.stpb:hover{box-shadow:0 0 20px rgba(239,68,68,.3)}
.ab{background:none;border:none;color:#475569;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;transition:.15s}.ab:hover{color:#00f0c0;background:rgba(0,240,192,.06)}
.dov{position:fixed;inset:0;z-index:50;background:rgba(0,240,192,.05);border:2px dashed rgba(0,240,192,.4);display:flex;align-items:center;justify-content:center;pointer-events:none}
.mc2{padding:6px 14px;border-radius:20px;border:1px solid #1e293b;background:#111827;color:#94a3b8;font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:5;transition:.15s;font-family:'Outfit',sans-serif;white-space:nowrap}
.mc2:hover{border-color:rgba(0,240,192,.3);color:#e2e8f0}.mc2.on{border-color:rgba(0,240,192,.4);color:#00f0c0;background:rgba(0,240,192,.06)}
.pm{position:absolute;bottom:calc(100% + 8px);left:0;background:#111827;border:1px solid #1e293b;border-radius:12px;padding:6px 0;min-width:220px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:10;animation:mi .15s ease}
.pi{padding:10px 16px;display:flex;align-items:center;gap:10px;color:#94a3b8;font-size:13px;cursor:pointer;transition:.1s}.pi:hover{background:rgba(0,240,192,.04);color:#e2e8f0}
.pii{width:20px;display:flex;justify-content:center;flex-shrink:0}.pdv{height:1px;background:#1e293b;margin:4px 0}
.dlc{margin:10px 0;padding:12px 16px;background:#0f1629;border:1px solid #1e293b;border-radius:10px;display:flex;align-items:center;gap:12px}.dlc:hover{border-color:rgba(0,240,192,.2)}
.dli{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#00f0c020,#a78bfa10);border:1px solid #1e293b;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.dlf{flex:1;min-width:0}.dln{font-size:13px;font-weight:600;color:#e2e8f0}.dls{font-size:11px;color:#475569;margin-top:2px}
.dlb{padding:6px 14px;border-radius:8px;background:rgba(0,240,192,.1);border:1px solid rgba(0,240,192,.2);color:#00f0c0;font-size:12px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;transition:.15s}.dlb:hover{background:rgba(0,240,192,.2)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s}
.modal{background:#111827;border:1px solid #1e293b;border-radius:16px;padding:28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.5);animation:mi .2s ease}
.modal h3{font-size:17px;font-weight:700;margin-bottom:8px;color:#e2e8f0}.modal p{font-size:13px;color:#94a3b8;line-height:1.5;margin-bottom:16px}
.modal-url{width:100%;padding:10px 14px;background:#0a0e17;border:1px solid #1e293b;border-radius:8px;color:#64748b;font-size:12px;font-family:'JetBrains Mono',monospace;margin-bottom:16px;word-break:break-all;overflow:hidden;text-overflow:ellipsis}
.modal-btns{display:flex;gap:10px;justify-content:flex-end}
.mbtn{padding:10px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;transition:.2s;border:none}
.mbtn-cancel{background:#1e293b;color:#94a3b8}.mbtn-cancel:hover{background:#2d3748;color:#e2e8f0}
.mbtn-go{background:linear-gradient(135deg,#00f0c0,#34d399);color:#0a0e17}.mbtn-go:hover{box-shadow:0 0 20px rgba(0,240,192,.3)}
.search-box{width:100%;padding:10px 14px 10px 36px;background:#0a0e17;border:1px solid #1e293b;border-radius:10px;color:#e2e8f0;font-size:13px;font-family:'Outfit',sans-serif;outline:none;transition:border-color .2s}
.search-box:focus{border-color:rgba(0,240,192,.3)}
.ctx-menu{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:none;gap:2px}
.ci:hover .ctx-menu{display:flex}
.ctx-btn{background:none;border:none;color:#475569;cursor:pointer;padding:2px;border-radius:3px;display:flex;align-items:center;transition:.1s}.ctx-btn:hover{color:#00f0c0}
.fpanel{position:fixed;top:0;right:0;width:50%;height:100%;background:#111827;border-left:1px solid #1e293b;z-index:30;display:flex;flex-direction:column;animation:fpSlide .2s ease;box-shadow:-8px 0 30px rgba(0,0,0,.4)}
@keyframes fpSlide{from{transform:translateX(100%)}to{transform:translateX(0)}}
.fpanel-bar{padding:10px 16px;border-bottom:1px solid #1e293b;display:flex;align-items:center;gap:10px;flex-shrink:0}
.fpanel iframe,.fpanel pre{flex:1;border:none;width:100%;background:#0a0e17}
@media(max-width:768px){.fpanel{width:100%;max-width:100%}}
@media(max-width:768px){.sidebar{position:fixed!important;z-index:20!important;height:100%!important;box-shadow:8px 0 30px rgba(0,0,0,.5)}.sb-overlay{position:fixed;inset:0;z-index:19;background:rgba(0,0,0,.4)}}
.lightbox{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;cursor:zoom-out;animation:fadeIn .15s}
.lightbox img{max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px;cursor:zoom-in;transition:transform .2s}
.lightbox .lb-close{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s}
.lightbox .lb-close:hover{background:rgba(255,255,255,.2)}
.msg-collapse{max-height:250px;overflow:hidden;position:relative}
.msg-collapse::after{content:"";position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(transparent,#111827);pointer-events:none;border-radius:0 0 12px 12px}
.show-more-btn{background:none;border:none;color:#00f0c0;font-size:12px;font-weight:600;cursor:pointer;padding:4px 0;font-family:'Outfit',sans-serif;opacity:.8;transition:.15s}
.show-more-btn:hover{opacity:1}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script type="text/babel">
const{useState,useRef,useEffect,useCallback}=React;
const IS_MOBILE=window.innerWidth<=768;
const API=window.location.hostname==="localhost"||window.location.protocol==="file:"?"https://api.anthropic.com/v1/messages":"/api/chat";
const BTN=42;
const MODELS=[
  {id:"claude-opus-4-6",nm:"Core 4.6",desc:"The most efficient for ambitious tasks.",c:"#a78bfa",bg:"#a78bfa20",locked:true},
  {id:"claude-sonnet-4-6",nm:"Pulse 4.6",desc:"The most effective for everyday tasks.",c:"#00f0c0",bg:"#00f0c020"},
  {id:"claude-sonnet-4-5-20250929",nm:"Pulse 4.5",desc:"Great balance of speed and intelligence.",c:"#34d399",bg:"#34d39920"},
  {id:"claude-haiku-4-5-20251001",nm:"Spark 4.5",desc:"The fastest way to get quick answers.",c:"#60a5fa",bg:"#60a5fa20"},
];
const MODES=[{icon:"</>",label:"Code",prompt:"Focus on writing clean, efficient code with explanations."},{icon:"âœï¸",label:"Write",prompt:"Focus on creative and professional writing."},{icon:"ğŸ“š",label:"Learn",prompt:"Explain concepts clearly with examples."}];
const SUGS=[{icon:"âš¡",text:"Write a Python web scraper",p:"Write a Python script that scrapes a website and exports data to CSV"},{icon:"ğŸ“˜",text:"Explain async/await in JS",p:"Explain how async/await works in JavaScript with examples"},{icon:"ğŸ”§",text:"Help me debug my code",p:"Debug this code and explain what's wrong with it"},{icon:"ğŸ—ï¸",text:"Design a REST API",p:"Design a REST API for a task management app with authentication"}];
const SYS=`You are an AI assistant called SynthEx, made by Slipail. Your models are Core 4.6, Pulse 4.6, Pulse 4.5, and Spark 4.5. Use SynthEx names instead of original names. Never mention Claude or Anthropic.

Be concise. Give short, direct answers. Don't over-explain or add unnecessary context. Match the length and effort to the question â€” simple questions get short answers.

You can generate files in ANY language/format. Always use a code block with the filename on the first line:
\`\`\`python
// filename: chatbot.py
import random
...
\`\`\`

Supported file types: .py, .js, .ts, .java, .cpp, .c, .go, .rs, .html, .css, .json, .xml, .yaml, .toml, .md, .txt, .csv, .sql, .sh, .bat, .rb, .php, .swift, .kt, .r, .lua, .jsx, .tsx, .vue, .svelte, .svg, and more.

For PDFs: generate as HTML with \`// filename: document.pdf\` â€” the viewer renders it as a styled document, and Save PDF opens the browser's print-to-PDF.

Always use the correct file extension for the language requested. Never default to HTML when another format is asked for. Keep files complete.`;

function parseMd(t){let h=t||"";
h=h.replace(/```(\w*)\n(?:\/\/|#)\s*filename:\s*(.+)\n([\s\S]*?)```/g,(match,lang,name,code)=>{const safe=btoa(unescape(encodeURIComponent(code.trim())));return'<div class="gen-status"><span class="gen-done">âœ“</span> Generated file</div><div class="fb" data-n="'+name.trim()+'" data-l="'+(lang||name.trim().split(".").pop())+'" data-c="'+safe+'"></div>';});
// Detect in-progress file generation (unclosed code block with filename)
h=h.replace(/```(\w*)\n(?:\/\/|#)\s*filename:\s*(.+)\n([\s\S]*)$/g,(match,lang,name,code)=>{return'<div class="gen-status"><span class="gen-spinner"></span> Generating '+name.trim()+'...</div><pre data-lang="'+(lang||"")+'" style="max-height:200px;overflow-y:auto"><code>'+code.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</code></pre>';});
h=h.replace(/```(\w*)\n([\s\S]*?)```/g,(_,l,c)=>'<pre data-lang="'+l+'"><code>'+c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+'</code></pre>');
h=h.replace(/`([^`]+)`/g,'<code class="ic">$1</code>');h=h.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");h=h.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g,"<em>$1</em>");
h=h.replace(/^### (.+)$/gm,"<h3>$1</h3>");h=h.replace(/^## (.+)$/gm,"<h2>$1</h2>");h=h.replace(/^# (.+)$/gm,"<h1>$1</h1>");
h=h.replace(/^> (.+)$/gm,"<blockquote>$1</blockquote>");
// Wrap consecutive bullet lines in <ul>
h=h.replace(/(?:^- .+$\n?)+/gm,(block)=>{const items=block.trim().split("\n").map(l=>"<li>"+l.replace(/^- /,"")+"</li>").join("");return"<ul>"+items+"</ul>";});
// Wrap consecutive numbered lines in <ol>
h=h.replace(/(?:^\d+\. .+$\n?)+/gm,(block)=>{const items=block.trim().split("\n").map(l=>"<li>"+l.replace(/^\d+\. /,"")+"</li>").join("");return"<ol>"+items+"</ol>";});
h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" data-ext="1">$1</a>');
h=h.replace(/(?<!["=])(https?:\/\/[^\s<)]+)/g,'<a href="$1" data-ext="1">$1</a>');
h=h.replace(/^(?!<[hpuolbq]|<li|<pre|<code|<strong|<em|<a|<block|<div)(.*\S.*)$/gm,"<p>$1</p>");return h;}

function dlFile(n,c){
  if(n.endsWith(".pdf")){
    // PDF: render HTML in iframe and trigger print-to-PDF
    const w2=window.open("","_blank");if(w2){w2.document.write(c);w2.document.close();setTimeout(()=>{w2.document.title=n;w2.print();},500);}return;
  }
  const mimes={".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".ts":"text/typescript",".json":"application/json",".xml":"application/xml",".svg":"image/svg+xml",".csv":"text/csv",".md":"text/markdown",".py":"text/x-python",".java":"text/x-java",".cpp":"text/x-c++src",".c":"text/x-csrc",".go":"text/x-go",".rs":"text/x-rust",".rb":"text/x-ruby",".php":"text/x-php",".sh":"text/x-sh",".bat":"text/x-bat",".sql":"text/x-sql",".yaml":"text/yaml",".yml":"text/yaml",".toml":"text/toml",".lua":"text/x-lua",".swift":"text/x-swift",".kt":"text/x-kotlin",".r":"text/x-r",".jsx":"text/jsx",".tsx":"text/tsx",".vue":"text/x-vue",".svelte":"text/x-svelte"};
  const ext="."+n.split(".").pop().toLowerCase();const mime=mimes[ext]||"text/plain";
  const b=new Blob([c],{type:mime});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download=n;a.click();URL.revokeObjectURL(u);
}

function FilePanel({file,onClose,onResize}){
  const iframeRef=useRef(null);const[w,setW]=useState(50);const[dragging,setDragging]=useState(false);const[viewMode,setViewMode]=useState("preview");
  const isHtml=file.name.endsWith(".html")||file.name.endsWith(".htm")||file.name.endsWith(".pdf");
  const isSvg=file.name.endsWith(".svg");
  const canPreview=isHtml||isSvg;
  useEffect(()=>{
    if((isHtml||isSvg)&&viewMode==="preview"&&iframeRef.current){
      const blob=new Blob([file.code],{type:"text/html"});
      const url=URL.createObjectURL(blob);
      iframeRef.current.src=url;
      return()=>URL.revokeObjectURL(url);
    }
  },[file,viewMode,isHtml,isSvg]);
  useEffect(()=>{if(!dragging)return;
    document.body.style.userSelect="none";document.body.style.cursor="col-resize";
    const mm=e=>{e.preventDefault();const pct=(e.clientX||e.touches?.[0]?.clientX||0)/window.innerWidth*100;const nw=Math.max(25,Math.min(75,100-pct));setW(nw);if(onResize)onResize(nw);};
    const mu=()=>{setDragging(false);document.body.style.userSelect="";document.body.style.cursor="";};
    document.addEventListener("mousemove",mm);document.addEventListener("mouseup",mu);document.addEventListener("touchmove",mm,{passive:false});document.addEventListener("touchend",mu);
    return()=>{document.removeEventListener("mousemove",mm);document.removeEventListener("mouseup",mu);document.removeEventListener("touchmove",mm);document.removeEventListener("touchend",mu);document.body.style.userSelect="";document.body.style.cursor="";};},[dragging]);
  function copyCode(){navigator.clipboard.writeText(file.code).then(()=>{});}
  const showPreview=canPreview&&viewMode==="preview";
  return<><div style={{position:"fixed",left:0,top:0,width:(100-w)+"%",height:"100%",zIndex:29,background:"transparent",pointerEvents:dragging?"auto":"none"}}/>
  <div className="fpanel" style={{width:w+"%",maxWidth:"none",pointerEvents:dragging?"none":"auto"}}>
    <div onMouseDown={()=>setDragging(true)} onTouchStart={()=>setDragging(true)} style={{position:"absolute",left:-4,top:0,width:8,height:"100%",cursor:"col-resize",zIndex:2}}><div style={{width:2,height:"100%",margin:"0 auto",background:dragging?"#00f0c0":"transparent",transition:"background .15s"}}/></div>
    <div className="fpanel-bar">
      <div style={{flex:1,display:"flex",alignItems:"center",gap:8,minWidth:0}}>
        <span style={{fontSize:15}}>{({py:"ğŸ",js:"ğŸ“œ",html:"ğŸŒ",css:"ğŸ¨",json:"ğŸ“‹",md:"ğŸ“",txt:"ğŸ“„",csv:"ğŸ“Š",pdf:"ğŸ“•",java:"â˜•",ts:"ğŸ“˜",jsx:"âš›ï¸",svg:"ğŸ¨",xml:"ğŸ“°",yaml:"ğŸ“„",sh:"ğŸ–¥ï¸",sql:"ğŸ—„ï¸"})[file.name.split(".").pop()]||"ğŸ“„"}</span>
        <span style={{fontSize:13,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{file.name}</span>
        <span style={{fontSize:10,color:"#475569"}}>{file.code.length} chars</span>
      </div>
      {canPreview&&<div style={{display:"flex",border:"1px solid #1e293b",borderRadius:6,overflow:"hidden"}}><button onClick={()=>setViewMode("preview")} style={{padding:"3px 8px",fontSize:10,fontWeight:600,background:viewMode==="preview"?"rgba(0,240,192,.1)":"transparent",color:viewMode==="preview"?"#00f0c0":"#64748b",border:"none",cursor:"pointer",fontFamily:"'Outfit'"}}>Preview</button><button onClick={()=>setViewMode("source")} style={{padding:"3px 8px",fontSize:10,fontWeight:600,background:viewMode==="source"?"rgba(0,240,192,.1)":"transparent",color:viewMode==="source"?"#00f0c0":"#64748b",border:"none",cursor:"pointer",fontFamily:"'Outfit'"}}>Source</button></div>}
      <button className="dlb" onClick={copyCode} style={{fontSize:11,padding:"4px 10px"}}>Copy</button>
      <button className="dlb" onClick={()=>dlFile(file.name,file.code)} style={{fontSize:11,padding:"4px 10px"}}>{file.name.endsWith(".pdf")?"Save PDF":"Download"}</button>
      <button onClick={onClose} style={{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",padding:4,fontSize:18,lineHeight:1}}>âœ•</button>
    </div>
    {showPreview?<iframe ref={iframeRef} style={{flex:1,background:"#fff",border:"none",width:"100%"}}/>:<pre style={{flex:1,margin:0,padding:16,overflowY:"auto",overflowX:"auto",color:"#d4d4d4",fontFamily:"'JetBrains Mono',monospace",fontSize:13,lineHeight:1.6,whiteSpace:"pre",background:"#0a0e17"}}>{file.code}</pre>}
  </div></>;
}

function MsgHtml({content,onLink,onView}){
  const ref=useRef(null);
  useEffect(()=>{if(!ref.current)return;
    ref.current.querySelectorAll("pre").forEach(pre=>{if(pre.querySelector(".cpb"))return;const b=document.createElement("button");b.className="cpb";b.textContent="Copy";b.onclick=()=>{navigator.clipboard.writeText(pre.querySelector("code")?.textContent||pre.textContent);b.textContent="Copied!";setTimeout(()=>b.textContent="Copy",1500);};pre.style.position="relative";pre.appendChild(b);});
    ref.current.querySelectorAll(".fb").forEach(div=>{if(div.childNodes.length>0)return;const nm=div.dataset.n,lang=div.dataset.l,code=decodeURIComponent(escape(atob(div.dataset.c)));const ext=nm.split(".").pop();const ic={py:"ğŸ",js:"ğŸ“œ",html:"ğŸŒ",css:"ğŸ¨",json:"ğŸ“‹",md:"ğŸ“",txt:"ğŸ“„",csv:"ğŸ“Š",pdf:"ğŸ“•",java:"â˜•",ts:"ğŸ“˜",jsx:"âš›ï¸",sql:"ğŸ—„ï¸",cpp:"âš™ï¸",go:"ğŸ”·",rs:"ğŸ¦€",rb:"ğŸ’",php:"ğŸ˜",sh:"ğŸ–¥ï¸",bat:"ğŸ–¥ï¸",swift:"ğŸ",kt:"ğŸŸ£",r:"ğŸ“ˆ",lua:"ğŸŒ™",c:"âš™ï¸",yaml:"ğŸ“„",yml:"ğŸ“„",toml:"ğŸ“„",xml:"ğŸ“°",vue:"ğŸ’š",svelte:"ğŸ”¥",tsx:"âš›ï¸"};
      const card=document.createElement("div");card.className="dlc";
      const desc=nm.endsWith(".pdf")?"PDF document":lang+" Â· "+code.length+" chars";
      card.innerHTML='<div class="dli">'+(ic[ext]||"ğŸ“„")+'</div><div class="dlf"><div class="dln">'+nm+'</div><div class="dls">'+desc+'</div></div><div style="display:flex;gap:6px"><button class="dlb vb">View</button><button class="dlb db">'+(nm.endsWith(".pdf")?"Save PDF":"Download")+'</button></div>';
      card.querySelector(".db").onclick=()=>dlFile(nm,code);card.querySelector(".vb").onclick=()=>onView({name:nm,code});div.appendChild(card);});
    ref.current.querySelectorAll("a[data-ext]").forEach(a=>{a.onclick=(e)=>{e.preventDefault();onLink(a.href);};});
  },[content]);
  return <div ref={ref} dangerouslySetInnerHTML={{__html:parseMd(content)}}/>;
}

function detectLang(t){const fr=/[Ã Ã¢Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§Å“Ã¦]|(?:^|\s)(?:je|tu|il|elle|nous|vous|ils|elles|le|la|les|un|une|des|du|de|et|est|sont|pas|que|qui|dans|pour|avec|sur|par|mais|ou|donc|ni|car)\s/i;const es=/[Ã¡Ã©Ã­Ã³ÃºÃ±Â¿Â¡]|(?:^|\s)(?:el|ella|ellos|nosotros|pero|como|para|por|con|sin|sobre|entre|hasta)\s/i;const de=/[Ã¤Ã¶Ã¼ÃŸ]|(?:^|\s)(?:ich|du|er|sie|wir|ihr|und|oder|aber|nicht|ein|eine|der|die|das)\s/i;if(fr.test(t))return"fr";if(es.test(t))return"es";if(de.test(t))return"de";return"en";}

function speakT(t,cb){speechSynthesis.cancel();const c=t.replace(/```[\s\S]*?```/g," code block ").replace(/[#*`_~\[\]()]/g,"").replace(/<[^>]*>/g,"").replace(/\n+/g,". ");const lang=detectLang(c);const u=new SpeechSynthesisUtterance(c);u.rate=1;u.lang=lang;
const v=speechSynthesis.getVoices();
// Prefer natural/premium voices, then Google, then any match
const pref=v.filter(x=>x.lang.startsWith(lang));
const natural=pref.find(x=>/natural|premium|enhanced|neural|samantha|karen|daniel|thomas/i.test(x.name));
const google=pref.find(x=>/google/i.test(x.name));
const pick=natural||google||pref[0]||v.find(x=>x.lang.startsWith("en"));
if(pick)u.voice=pick;u.onend=cb;u.onerror=cb;speechSynthesis.speak(u);}

// Link warning modal
function LinkModal({url,onClose,onGo}){
  const[skip,setSkip]=useState(false);
  return<div className="overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>Leaving SynthEx</h3>
    <p>You're about to visit an external website.</p>
    <div className="modal-url">{url}</div>
    <div className="modal-btns" style={{justifyContent:"center"}}>
      <button className="mbtn mbtn-cancel" onClick={onClose}>Stay Here</button>
      <button className="mbtn mbtn-go" style={{padding:"10px 28px"}} onClick={()=>{if(skip)localStorage.setItem("sx-skip-link","1");onGo();}}>Visit Website</button>
    </div>
    <label style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8,marginTop:14,cursor:"pointer",fontSize:12,color:"#64748b"}}><input type="checkbox" checked={skip} onChange={e=>setSkip(e.target.checked)} style={{accentColor:"#00f0c0"}}/>Don't show this again</label>
  </div></div>;
}

// Rename modal
function RenameModal({name,onClose,onSave}){
  const[v,setV]=useState(name);
  return<div className="overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>Rename Conversation</h3>
    <input value={v} onChange={e=>setV(e.target.value)} onKeyDown={e=>{if(e.key==="Enter")onSave(v);}} style={{width:"100%",padding:"10px 14px",background:"#0a0e17",border:"1px solid #1e293b",borderRadius:8,color:"#e2e8f0",fontSize:14,fontFamily:"'Outfit',sans-serif",outline:"none",marginBottom:16}} autoFocus/>
    <div className="modal-btns"><button className="mbtn mbtn-cancel" onClick={onClose}>Cancel</button><button className="mbtn mbtn-go" onClick={()=>onSave(v)}>Save</button></div>
  </div></div>;
}

function DeleteModal({name,onClose,onDelete}){
  return<div className="overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>Delete Conversation</h3>
    <p>Are you sure you want to delete <strong style={{color:"#e2e8f0"}}>"{name}"</strong>? This action cannot be undone.</p>
    <div className="modal-btns"><button className="mbtn mbtn-cancel" onClick={onClose}>Cancel</button><button className="mbtn" style={{background:"#ef4444",color:"#fff"}} onClick={onDelete}>Delete</button></div>
  </div></div>;
}

function ImageLightbox({src,onClose}){
  const[zoomed,setZoomed]=useState(false);const[pos,setPos]=useState({x:50,y:50});
  function handleClick(e){if(zoomed){setZoomed(false);}else{const rect=e.currentTarget.getBoundingClientRect();const x=((e.clientX-rect.left)/rect.width)*100;const y=((e.clientY-rect.top)/rect.height)*100;setPos({x,y});setZoomed(true);}}
  return<div className="lightbox" onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
    <button className="lb-close" onClick={onClose}>âœ•</button>
    <img src={src} alt="" onClick={handleClick} style={{transform:zoomed?"scale(2.5)":"scale(1)",transformOrigin:pos.x+"% "+pos.y+"%",cursor:zoomed?"zoom-out":"zoom-in"}}/>
  </div>;
}

const Ic={
  Copy:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>,
  Spk:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>,
  Mut:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>,
  Reg:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>,
  L:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="15 18 9 12 15 6"/></svg>,
  R:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="9 18 15 12 9 6"/></svg>,
  X:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  Pls:()=><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Fl:()=><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>,
  Im:()=><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
  Gl:()=><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>,
  Ch:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00f0c0" strokeWidth="2.5"><polyline points="20 6 9 17 4 12"/></svg>,
  Br:()=><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a7 7 0 017 7c0 2.5-1.3 4.7-3.2 6H8.2C6.3 13.7 5 11.5 5 9a7 7 0 017-7z"/><path d="M9 22h6"/><path d="M10 18h4"/></svg>,
  Snd:()=><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0a0e17" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
  Srch:()=><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  Edit:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  Del:()=><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>,
};

const GOOGLE_CLIENT_ID="515903818908-35mcjhpctmhsh3gs6meuq9ob8q69g8ft.apps.googleusercontent.com";

function decodeJwt(token){try{const base64=token.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(decodeURIComponent(atob(base64).split("").map(c=>"%" + ("00"+c.charCodeAt(0).toString(16)).slice(-2)).join("")));}catch{return null;}}

function PricingPage({onClose}){
  return<div style={{position:"fixed",inset:0,zIndex:100,background:"#0a0e17",color:"#e2e8f0",overflow:"auto",fontFamily:"'Outfit'",animation:"fadeIn .2s"}}>
    <div style={{maxWidth:900,margin:"0 auto",padding:"40px 20px"}}>
      <div style={{textAlign:"center",marginBottom:40}}><h1 style={{fontSize:32,fontWeight:800,background:"linear-gradient(135deg,#00f0c0,#60a5fa)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>SynthEx Plans</h1><p style={{color:"#64748b",marginTop:8}}>Choose the plan that works for you</p></div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(260px,1fr))",gap:20}}>
        {[{name:"Free",price:"$0",desc:"Get started with SynthEx",features:["Pulse 4.5 & Pulse 4.6 access","15 messages per 6 hours","Spark 4.5 (25 messages/6hr)","File generation","Web search","Cloud sync"],btn:"Current Plan",dis:true},
          {name:"Premium",price:"$12",period:"/month",desc:"More power, more access.",features:["Everything in Free","Core 4.6 (most intelligent)","100 messages per 6 hours","Priority responses","Extended thinking","Early access to new models"],btn:"Coming Soon",dis:true,hl:true},
          {name:"Max",price:"$40",period:"/month",desc:"For power users.",features:["Everything in Premium","500 messages per 6 hours","API access","Custom system prompts","Priority support"],btn:"Coming Soon",dis:true}
        ].map((p,i)=><div key={i} style={{background:p.hl?"linear-gradient(135deg,rgba(0,240,192,.05),rgba(167,139,250,.05))":"#111827",border:p.hl?"1px solid rgba(0,240,192,.3)":"1px solid #1e293b",borderRadius:16,padding:28,display:"flex",flexDirection:"column"}}>
          <h2 style={{fontSize:20,fontWeight:700}}>{p.name}</h2>
          <div style={{margin:"12px 0"}}><span style={{fontSize:36,fontWeight:800}}>{p.price}</span>{p.period&&<span style={{color:"#64748b",fontSize:14}}>{p.period}</span>}</div>
          <p style={{fontSize:13,color:"#64748b",marginBottom:16}}>{p.desc}</p>
          <button disabled={p.dis} style={{width:"100%",padding:12,borderRadius:10,border:"none",fontSize:14,fontWeight:700,fontFamily:"'Outfit'",background:p.hl?"linear-gradient(135deg,#00f0c0,#34d399)":"#1e293b",color:p.hl?"#0a0e17":"#94a3b8",cursor:p.dis?"default":"pointer",marginBottom:20}}>{p.btn}</button>
          <div style={{flex:1}}>{p.features.map((f,j)=><div key={j} style={{display:"flex",gap:8,alignItems:"flex-start",marginBottom:8,fontSize:13,color:"#94a3b8"}}><span style={{color:"#00f0c0",fontSize:14,lineHeight:1}}>âœ“</span>{f}</div>)}</div>
        </div>)}
      </div>
      <div style={{textAlign:"center",marginTop:30}}><button onClick={onClose} style={{background:"none",border:"1px solid #1e293b",color:"#94a3b8",padding:"8px 24px",borderRadius:8,cursor:"pointer",fontSize:13,fontFamily:"'Outfit'"}}>â† Back to chat</button></div>
    </div>
  </div>;
}

function Login({onLogin}){
  const gBtnRef=useRef(null);const[ld,setLd]=useState(false);const[err,setErr]=useState("");
  useEffect(()=>{
    const interval=setInterval(()=>{
      if(window.google?.accounts?.id&&gBtnRef.current){
        clearInterval(interval);
        window.google.accounts.id.initialize({
          client_id:GOOGLE_CLIENT_ID,
          callback:(response)=>{
            const payload=decodeJwt(response.credential);
            if(payload){onLogin({email:payload.email,name:payload.name||payload.email.split("@")[0],picture:payload.picture,method:"google"});}
            else{setErr("Failed to decode login");setLd(false);}
          },
        });
        window.google.accounts.id.renderButton(gBtnRef.current,{
          type:"standard",theme:"filled_black",size:"large",width:320,text:"continue_with",shape:"pill",logo_alignment:"left",
        });
      }
    },100);
    return()=>clearInterval(interval);
  },[]);
  return<div style={{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"#0a0e17",position:"relative",overflow:"hidden"}}>
    <div className="gridbg"/><div className="gorb" style={{width:500,height:500,background:"#00f0c0",top:-150,left:-100,animation:"of 15s ease-in-out infinite"}}/><div className="gorb" style={{width:400,height:400,background:"#a78bfa",bottom:-100,right:-80,animation:"of 18s ease-in-out infinite reverse"}}/>
    <div style={{width:380,maxWidth:"90vw",position:"relative",zIndex:1}}>
      <div style={{textAlign:"center",marginBottom:32}}>
        <div style={{width:64,height:64,borderRadius:16,background:"linear-gradient(135deg,#00f0c0,#a78bfa)",display:"inline-flex",alignItems:"center",justifyContent:"center",fontFamily:"'JetBrains Mono'",fontWeight:700,fontSize:22,color:"#0a0e17",boxShadow:"0 0 40px #00f0c030",marginBottom:14}}>SX</div>
        <h1 style={{fontSize:28,fontWeight:800,background:"linear-gradient(135deg,#00f0c0,#60a5fa)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>SynthEx</h1>
        <p style={{color:"#64748b",fontSize:13,marginTop:6}}>Sign in to save your conversations</p>
      </div>
      <div style={{background:"#111827",borderRadius:16,border:"1px solid #1e293b",padding:28,boxShadow:"0 20px 60px rgba(0,0,0,.4)",display:"flex",flexDirection:"column",alignItems:"center",gap:20}}>
        <div ref={gBtnRef} style={{minHeight:44,display:"flex",alignItems:"center",justifyContent:"center"}}>{!window.google&&<span style={{color:"#64748b",fontSize:13}}>Loading Google Sign-In...</span>}</div>
        {err&&<p style={{color:"#ef4444",fontSize:12}}>{err}</p>}
      </div>
    </div>
  </div>;
}

function Cm({children,ai}){
  const ref=useRef(null);const[tall,setTall]=useState(false);const[exp,setExp]=useState(false);
  useEffect(()=>{if(ref.current)setTall(ref.current.scrollHeight>250);});
  const cls=tall&&!exp?"msg-collapse":"";
  return<><div ref={ref} className={cls} style={{padding:"12px 16px",borderRadius:12,lineHeight:1.7,fontSize:14,background:ai?"#111827":"linear-gradient(135deg,rgba(0,240,192,.06),rgba(0,240,192,.03))",border:ai?"1px solid #1e293b":"1px solid rgba(0,240,192,.15)",userSelect:"text",wordBreak:"break-word"}}>{children}</div>{tall&&<button className="show-more-btn" onClick={()=>setExp(!exp)}>{exp?"Show less":"Show more"}</button>}</>;
}

function App({user,onLogout}){
  const[chats,setChats]=useState({});const[cur,setCur]=useState(null);const[mdl,setMdl]=useState(MODELS[1]);const[input,setInput]=useState(()=>{try{return localStorage.getItem("sx-draft")||"";}catch{return"";}});const[stm,setStm]=useState(false);const[sb,setSb]=useState(!IS_MOBILE);const[files,setFiles]=useState([]);const[spk,setSpk]=useState(null);const[dg,setDg]=useState(false);const[pm,setPm]=useState(false);const[ws,setWs]=useState(true);const[et,setEt]=useState(false);const[mode,setMode]=useState(null);
  useEffect(()=>{try{localStorage.setItem("sx-draft",input);}catch{}},[input]);
  const[linkUrl,setLinkUrl]=useState(null);const[renChat,setRenChat]=useState(null);const[search,setSearch]=useState("");const[delChatId,setDelChatId]=useState(null);const[viewF,setViewF]=useState(null);const[lbSrc,setLbSrc]=useState(null);const[limitMsg,setLimitMsg]=useState(null);const[showPricing,setShowPricing]=useState(false);const[fpW,setFpW]=useState(50);
  // Usage limits: per model tier, 6 hour window
  const LIMITS={
    "claude-opus-4-6":{msgs:25,window:6*60*60*1000},
    "claude-sonnet-4-6":{msgs:15,window:6*60*60*1000},
    "claude-sonnet-4-5-20250929":{msgs:15,window:6*60*60*1000},
    "claude-haiku-4-5-20251001":{msgs:25,window:6*60*60*1000},
  };
  function getUsage(){try{return JSON.parse(localStorage.getItem("sx-usage")||"{}") }catch{return{};}}
  function checkLimit(){const u=getUsage();const now=Date.now();const k=mdl.id;const lim=LIMITS[k]||{msgs:25,window:6*60*60*1000};if(!u[k])return{ok:true,left:lim.msgs,max:lim.msgs};const recent=u[k].filter(t=>now-t<lim.window);if(recent.length>=lim.msgs){const oldest=Math.min(...recent);const reset=new Date(oldest+lim.window);return{ok:false,left:0,max:lim.msgs,reset};}return{ok:true,left:lim.msgs-recent.length,max:lim.msgs};}
  function recordUsage(){const u=getUsage();const k=mdl.id;const now=Date.now();const lim=LIMITS[k]||{msgs:25,window:6*60*60*1000};u[k]=(u[k]||[]).filter(t=>now-t<lim.window);u[k].push(now);localStorage.setItem("sx-usage",JSON.stringify(u));}
  const endR=useRef(null);const abR=useRef(null);const sR=useRef(false);const fR=useRef(null);const mR=useRef(null);const taR=useRef(null);const svT=useRef(null);

  const msgs=cur&&chats[cur]?chats[cur].messages:[];
  const chatRef=useRef(null);const userScrolled=useRef(false);const[showScrollBtn,setShowScrollBtn]=useState(false);
  function scrollToBottom(){userScrolled.current=false;setShowScrollBtn(false);endR.current?.scrollIntoView({behavior:"smooth"});}
  const scr=useCallback(()=>{if(!userScrolled.current&&endR.current)endR.current.scrollIntoView({behavior:"smooth"});},[]);
  useEffect(scr,[msgs.length]);
  // Only auto-scroll on content update if user hasn't scrolled up
  useEffect(()=>{if(!userScrolled.current&&endR.current&&stm)endR.current.scrollIntoView({behavior:"auto"});},[msgs[msgs.length-1]?.content]);
  useEffect(()=>{const el=chatRef.current;if(!el)return;const h=()=>{const gap=el.scrollHeight-el.scrollTop-el.clientHeight;const atBottom=gap<100;if(!atBottom&&stm){userScrolled.current=true;setShowScrollBtn(true);}else if(atBottom){userScrolled.current=false;setShowScrollBtn(false);}else{setShowScrollBtn(gap>300);}};el.addEventListener("scroll",h);return()=>el.removeEventListener("scroll",h);},[stm]);
  // Reset on new user message
  useEffect(()=>{if(msgs.length>0&&msgs[msgs.length-1]?.role==="assistant"&&msgs[msgs.length-1]?.content===""){userScrolled.current=false;setShowScrollBtn(false);}},[msgs.length]);
  const cids=Object.keys(chats).filter(id=>chats[id].messages.length>0).sort((a,b)=>(chats[b].updatedAt||0)-(chats[a].updatedAt||0));
  const filteredCids=search?cids.filter(id=>(chats[id].title||"").toLowerCase().includes(search.toLowerCase())||chats[id].messages.some(m=>m.content&&m.content.toLowerCase().includes(search.toLowerCase()))):cids;
  useEffect(()=>{speechSynthesis.getVoices();},[]);
  useEffect(()=>{if(taR.current&&!IS_MOBILE)taR.current.focus();},[cur,msgs.length===0]);
  // Fix mobile keyboard viewport
  useEffect(()=>{if(!IS_MOBILE)return;
    const setH=()=>{const h=window.visualViewport?.height||window.innerHeight;document.getElementById("root").style.height=h+"px";};
    setH();
    if(window.visualViewport){window.visualViewport.addEventListener("resize",setH);window.visualViewport.addEventListener("scroll",()=>{window.scrollTo(0,0);setH();});}
    window.addEventListener("resize",setH);
    return()=>{if(window.visualViewport){window.visualViewport.removeEventListener("resize",setH);}window.removeEventListener("resize",setH);};
  },[]);
  useEffect(()=>{function gk(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"||e.target.isContentEditable||e.ctrlKey||e.metaKey||e.altKey)return;if(e.key.length===1&&taR.current){taR.current.focus();}}document.addEventListener("keydown",gk);return()=>document.removeEventListener("keydown",gk);},[]);
  useEffect(()=>{const h=e=>{if(mR.current&&!mR.current.contains(e.target))setPm(false);};document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[]);

  // URL routing â€” restore chat from URL after chats load
  const chatsLoaded=useRef(false);
  useEffect(()=>{try{const d=localStorage.getItem("sx-chats");if(d){const parsed=JSON.parse(d);setChats(parsed);
    const path=window.location.pathname;const m=path.match(/^\/chat\/(.+)/);if(m&&m[1]&&parsed[m[1]])setCur(m[1]);
  }}catch{}chatsLoaded.current=true;},[]);
  useEffect(()=>{if(!chatsLoaded.current)return;if(cur){window.history.replaceState(null,"","/chat/"+cur);}else{window.history.replaceState(null,"","/");}},[cur]);
  useEffect(()=>{
    if(!db||!user?.email||user.email==="guest")return;
    // Load from cloud on login
    db.collection("users").doc(user.email).get().then(doc=>{
      if(doc.exists&&doc.data().chats){
        const cloud=doc.data().chats;
        setChats(prev=>{
          // Merge: keep whichever has more messages per chat
          const merged={...prev};
          for(const[k,v]of Object.entries(cloud)){
            if(!merged[k]||v.messages.length>merged[k].messages.length)merged[k]=v;
          }
          return merged;
        });
      }
    }).catch(()=>{});
  },[user]);
  useEffect(()=>{clearTimeout(svT.current);svT.current=setTimeout(()=>{try{const s={};for(const[k,v]of Object.entries(chats))if(v.messages.length>0)s[k]=v;localStorage.setItem("sx-chats",JSON.stringify(s));
    // Cloud save
    if(db&&user?.email&&user.email!=="guest"){db.collection("users").doc(user.email).set({chats:s,updated:Date.now()},{merge:true}).catch(()=>{});}
  }catch{}},1200);},[chats]);

  function openLink(url){if(localStorage.getItem("sx-skip-link")==="1"){window.open(url,"_blank");}else{setLinkUrl(url);}}
  function fresh(){setCur(null);setInput("");setFiles([]);setMode(null);if(IS_MOBILE)setSb(false);}
  function selectChat(id){setCur(id);if(IS_MOBILE)setSb(false);}
  function useSug(p){if(sR.current)return;setInput("");doSend(p);}
  function onKey(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();if(!sR.current)doSend();}}
  function onPaste(e){const items=e.clipboardData?.items;if(!items)return;for(const item of items){if(item.type.startsWith("image/")){e.preventDefault();const f=item.getAsFile();if(!f)return;const r=new FileReader();r.onload=()=>{setFiles(p=>[...p,{name:"pasted-image.png",type:f.type,data:r.result.split(",")[1],preview:r.result}]);};r.readAsDataURL(f);return;}}}
  function hFiles(fl){Array.from(fl).forEach(f=>{if(f.size>20*1024*1024)return;if(!["image/png","image/jpeg","image/gif","image/webp","application/pdf"].includes(f.type)&&!f.type.startsWith("text/"))return;const r=new FileReader();r.onload=()=>{setFiles(p=>[...p,{name:f.name,type:f.type,data:r.result.split(",")[1],preview:f.type.startsWith("image/")?r.result:null}]);};r.readAsDataURL(f);});setPm(false);}
  function bC(text,af){if(!af.length)return text;const parts=[];af.forEach(f=>{if(f.type.startsWith("image/"))parts.push({type:"image",source:{type:"base64",media_type:f.type,data:f.data}});else if(f.type==="application/pdf")parts.push({type:"document",source:{type:"base64",media_type:"application/pdf",data:f.data}});else parts.push({type:"text",text:"[File: "+f.name+"]\n"+atob(f.data)});});if(text)parts.push({type:"text",text});return parts;}
  function delChat(id){setChats(p=>{const n={...p};delete n[id];return n;});if(cur===id)setCur(null);setDelChatId(null);}
  function renameChat(id,name){setChats(p=>({...p,[id]:{...p[id],title:name}}));setRenChat(null);}

  async function doSend(ov){
    const text=(ov||input).trim();if((!text&&!files.length)||sR.current)return;
    const lim=checkLimit();if(!lim.ok){const ms=lim.reset-Date.now();const hrs=Math.floor(ms/3600000);const mins=Math.ceil((ms%3600000)/60000);const tStr=hrs>0?hrs+"h "+mins+"min":mins+"min";setLimitMsg("You've reached your limit for "+mdl.nm+". Resets in "+tStr+".");return;}
    recordUsage();
    sR.current=true;setStm(true);setInput("");const af=[...files];setFiles([]);
    if(taR.current)taR.current.style.height="auto";
    let cid=cur;if(!cid||!chats[cid])cid="c_"+Date.now();
    const title=(!chats[cid]||!chats[cid].messages.length)?(text||af[0]?.name||"Chat").substring(0,45):chats[cid].title;
    const prev=chats[cid]?.messages||[];
    setChats(p=>({...p,[cid]:{title,messages:[...prev,{role:"user",content:text,files:af.map(f=>({name:f.name,preview:f.preview,type:f.type})),ts:Date.now()},{role:"assistant",content:"",model:mdl.nm,versions:[],versionIdx:0,ts:Date.now()}],updatedAt:Date.now()}}));
    setCur(cid);const modeP=mode?"\n\n"+mode.prompt:"";const sys=SYS+"\nYou are currently running as "+mdl.nm+"."+modeP;let full="";
    try{
      abR.current=new AbortController();
      const am=[];for(const m of[...prev,{role:"user",content:bC(text,af)}]){if(m.role==="user")am.push({role:"user",content:m.content||""});else{const c=m.versions?.length>0?m.versions[m.versionIdx||0]:m.content;if(c)am.push({role:"assistant",content:c});}}
      const body={model:mdl.id,max_tokens:16000,system:sys,messages:am,stream:true};
      if(ws)body.tools=[{type:"web_search_20250305",name:"web_search"}];
      if(et)body.thinking={type:"enabled",budget_tokens:10000};
      const resp=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),signal:abR.current.signal});
      if(!resp.ok){const e=await resp.json().catch(()=>({}));throw new Error(e.error?.message||"API Error "+resp.status);}
      const reader=resp.body.getReader();const dec=new TextDecoder();let done2=false;let buf="";
      while(!done2){const{done,value}=await reader.read();if(done){done2=true;break;}buf+=dec.decode(value,{stream:true});const lines=buf.split("\n");buf=lines.pop()||"";for(const line of lines){if(!line.startsWith("data: "))continue;const d=line.slice(6);if(d==="[DONE]")continue;try{const p=JSON.parse(d);if(p.type==="content_block_delta"&&p.delta?.text){full+=p.delta.text;const cap=full;setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[m.length-1]={...m[m.length-1],content:cap};return{...pr,[cid]:{...ch,messages:m}};});}if(p.type==="message_stop")done2=true;}catch{}}}
    }catch(err){if(err.name!=="AbortError"){full=full||"\u26a0\ufe0f **Error:** "+err.message;setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[m.length-1]={...m[m.length-1],content:full};return{...pr,[cid]:{...ch,messages:m}};});}}
    if(full)setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[m.length-1]={...m[m.length-1],content:full,versions:[full],versionIdx:0};return{...pr,[cid]:{...ch,messages:m}};});
    sR.current=false;setStm(false);abR.current=null;
  }

  async function regen(mi){if(sR.current||!cur)return;sR.current=true;setStm(true);const cid=cur;let full="";try{abR.current=new AbortController();const cm=chats[cid].messages;const am=[];for(let i=0;i<mi;i++){const m=cm[i];if(m.role==="user")am.push({role:"user",content:m.content||""});else{const c=m.versions?.length>0?m.versions[m.versionIdx||0]:m.content;if(c)am.push({role:"assistant",content:c});}}setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[mi]={...m[mi],content:""};return{...pr,[cid]:{...ch,messages:m}};});const modeP=mode?"\n\n"+mode.prompt:"";const sys=SYS+"\nYou are currently running as "+mdl.nm+"."+modeP;const body={model:mdl.id,max_tokens:16000,system:sys,messages:am,stream:true};if(ws)body.tools=[{type:"web_search_20250305",name:"web_search"}];const resp=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),signal:abR.current.signal});if(!resp.ok)throw new Error("API Error "+resp.status);const reader=resp.body.getReader();const dec=new TextDecoder();let done2=false;let buf="";while(!done2){const{done,value}=await reader.read();if(done){done2=true;break;}buf+=dec.decode(value,{stream:true});const lines=buf.split("\n");buf=lines.pop()||"";for(const line of lines){if(!line.startsWith("data: "))continue;const d=line.slice(6);if(d==="[DONE]")continue;try{const p=JSON.parse(d);if(p.type==="content_block_delta"&&p.delta?.text){full+=p.delta.text;const cap=full;setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[mi]={...m[mi],content:cap};return{...pr,[cid]:{...ch,messages:m}};});}if(p.type==="message_stop")done2=true;}catch{}}}}catch(err){if(err.name!=="AbortError")setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];m[mi]={...m[mi],content:full||"\u26a0\ufe0f "+err.message};return{...pr,[cid]:{...ch,messages:m}};});}if(full)setChats(pr=>{const ch=pr[cid];if(!ch)return pr;const m=[...ch.messages];const pv=m[mi];const vs=[...(pv.versions||[]),full];m[mi]={...pv,content:full,versions:vs,versionIdx:vs.length-1,model:mdl.nm};return{...pr,[cid]:{...ch,messages:m}};});sR.current=false;setStm(false);abR.current=null;}

  function switchV(mi,dir){setChats(pr=>{const ch=pr[cur];if(!ch)return pr;const m=[...ch.messages];const msg=m[mi];if(!msg.versions||msg.versions.length<=1)return pr;let ni=(msg.versionIdx||0)+dir;if(ni<0)ni=msg.versions.length-1;if(ni>=msg.versions.length)ni=0;m[mi]={...msg,versionIdx:ni,content:msg.versions[ni]};return{...pr,[cur]:{...ch,messages:m}};});}
  function stop(){if(abR.current)abR.current.abort();sR.current=false;setStm(false);abR.current=null;}
  function copyM(t){navigator.clipboard.writeText(t.replace(/\*\*/g,"").replace(/```\w*\n?/g,"").replace(/`/g,"").replace(/^#{1,3} /gm,""));}
  function togSpk(i,t){if(spk===i){speechSynthesis.cancel();setSpk(null);}else{speakT(t,()=>setSpk(null));setSpk(i);}}
  const wel=msgs.length===0;

  return<div style={{display:"flex",height:"100%",background:"#0a0e17",color:"#e2e8f0",fontFamily:"'Outfit','Segoe UI',sans-serif",position:"relative",overflow:"hidden"}} onDrop={e=>{e.preventDefault();setDg(false);hFiles(e.dataTransfer.files);}} onDragOver={e=>{e.preventDefault();setDg(true);}} onDragLeave={()=>setDg(false)}>
    <div className="gridbg"/><div className="gorb" style={{width:500,height:500,background:"#00f0c0",top:-150,left:-100,animation:"of 15s ease-in-out infinite"}}/><div className="gorb" style={{width:400,height:400,background:"#a78bfa",bottom:-100,right:-80,animation:"of 18s ease-in-out infinite reverse"}}/><div className="gorb" style={{width:300,height:300,background:"#60a5fa",top:"40%",left:"50%",animation:"of 12s ease-in-out infinite 3s"}}/>
    {dg&&<div className="dov"><span style={{color:"#00f0c0",fontSize:20,fontWeight:600}}>Drop files here</span></div>}
    <input ref={fR} type="file" multiple accept="image/*,.pdf,.txt,.csv,.json,.js,.py,.html,.css,.md,.ts,.jsx,.tsx,.sql,.java,.cpp,.c,.rb,.go,.rs,.sh,.php,.xml,.yaml,.yml" style={{display:"none"}} onChange={e=>{hFiles(e.target.files);e.target.value="";}}/>
    {linkUrl&&<LinkModal url={linkUrl} onClose={()=>setLinkUrl(null)} onGo={()=>{window.open(linkUrl,"_blank");setLinkUrl(null);}}/>}
    {renChat&&<RenameModal name={chats[renChat]?.title||""} onClose={()=>setRenChat(null)} onSave={n=>renameChat(renChat,n)}/>}
    {delChatId&&chats[delChatId]&&<DeleteModal name={chats[delChatId].title||"this chat"} onClose={()=>setDelChatId(null)} onDelete={()=>delChat(delChatId)}/>}
    {viewF&&<FilePanel file={viewF} onClose={()=>setViewF(null)} onResize={setFpW}/>}
    {lbSrc&&<ImageLightbox src={lbSrc} onClose={()=>setLbSrc(null)}/>}
    {limitMsg&&<div className="overlay" onClick={()=>setLimitMsg(null)}><div className="modal" onClick={e=>e.stopPropagation()} style={{textAlign:"center"}}><div style={{fontSize:36,marginBottom:12}}>â³</div><h3>Message Limit Reached</h3><p>{limitMsg}</p><p style={{fontSize:12,color:"#64748b"}}>Try switching to a different model.</p><div style={{display:"flex",justifyContent:"center",gap:8,marginTop:4}}>{MODELS.filter(m=>!m.locked&&m.id!==mdl.id).map(m=><button key={m.id} className="mbtn" onClick={()=>{setMdl(m);setLimitMsg(null);}} style={{background:m.c+"20",color:m.c,border:"1px solid "+m.c+"40",padding:"6px 14px",fontSize:12}}>{m.nm}</button>)}</div><button className="mbtn mbtn-cancel" onClick={()=>setLimitMsg(null)} style={{marginTop:14,width:"100%"}}>OK</button></div></div>}
    {showPricing&&<PricingPage onClose={()=>setShowPricing(false)}/>}

    {/* Mobile sidebar overlay */}
    {IS_MOBILE&&sb&&<div className="sb-overlay" onClick={()=>setSb(false)}/>}

    {/* Sidebar */}
    <aside className={IS_MOBILE?"sidebar":""} style={{width:sb?280:0,minWidth:sb?280:0,background:"#0d1220",borderRight:sb?"1px solid #1e293b":"none",display:"flex",flexDirection:"column",transition:"all .3s",overflow:"hidden",position:"relative",zIndex:IS_MOBILE?20:2}}>
      <div style={{padding:20,borderBottom:"1px solid #1e293b",display:"flex",alignItems:"center",gap:12,flexShrink:0}}><div style={{width:40,height:40,borderRadius:10,background:"linear-gradient(135deg,#00f0c0,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"'JetBrains Mono'",fontWeight:700,fontSize:14,color:"#0a0e17",boxShadow:"0 0 20px #00f0c030"}}>SX</div><span style={{fontWeight:800,fontSize:22,background:"linear-gradient(135deg,#00f0c0,#60a5fa)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>SynthEx</span></div>
      <button className="ncb" onClick={fresh} style={{margin:"12px 16px 6px",padding:12,background:"linear-gradient(135deg,rgba(0,240,192,.06),rgba(167,139,250,.04))",border:"1px solid rgba(0,240,192,.15)",borderRadius:10,color:"#00f0c0",fontSize:14,fontWeight:600,cursor:"pointer",display:"flex",alignItems:"center",gap:8}}><span style={{fontSize:18,lineHeight:1}}>+</span>New Chat</button>
      {/* Search */}
      <div style={{padding:"6px 16px",position:"relative"}}><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2" style={{position:"absolute",left:28,top:16}}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input className="search-box" value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search conversations..."/></div>
      <div style={{flex:1,overflowY:"auto",padding:8}}>{filteredCids.map(id=><div key={id} className="ci" onClick={()=>selectChat(id)} style={{padding:"10px 40px 10px 16px",borderRadius:8,cursor:"pointer",marginBottom:2,color:id===cur?"#00f0c0":"#94a3b8",fontSize:13,background:id===cur?"rgba(0,240,192,.04)":"transparent",border:id===cur?"1px solid rgba(0,240,192,.1)":"1px solid transparent",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",position:"relative"}}>{chats[id].title}<div className="ctx-menu"><button className="ctx-btn" onClick={e=>{e.stopPropagation();setRenChat(id);}} title="Rename"><Ic.Edit/></button><button className="ctx-btn" onClick={e=>{e.stopPropagation();setDelChatId(id);}} title="Delete"><Ic.Del/></button></div></div>)}</div>
      <div style={{padding:16,borderTop:"1px solid #1e293b",flexShrink:0}}>
        <div style={{fontSize:11,fontWeight:600,color:"#475569",textTransform:"uppercase",letterSpacing:1.5,marginBottom:8}}>Model</div>
        {MODELS.map(m=><div key={m.id} className={m.locked?"":"mo"} onClick={()=>{if(m.locked)setShowPricing(true);else setMdl(m);}} style={{padding:"8px 12px",borderRadius:8,cursor:"pointer",display:"flex",alignItems:"center",gap:10,marginBottom:2,background:mdl.id===m.id&&!m.locked?"rgba(0,240,192,.03)":"transparent",border:mdl.id===m.id&&!m.locked?"1px solid rgba(0,240,192,.12)":"1px solid transparent",opacity:m.locked?.6:1}}><div style={{flex:1,minWidth:0}}><div style={{fontSize:13,fontWeight:600,display:"flex",alignItems:"center",gap:6}}>{m.nm}{m.locked&&<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>}{!m.locked&&mdl.id===m.id&&<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#00f0c0" strokeWidth="2.5"><polyline points="20 6 9 17 4 12"/></svg>}</div><div style={{fontSize:11,color:"#64748b",marginTop:1}}>{m.desc}</div></div>{m.locked&&<span style={{fontSize:10,fontWeight:700,padding:"3px 8px",borderRadius:5,color:"#a78bfa",background:"#a78bfa15",whiteSpace:"nowrap",flexShrink:0}}>Upgrade</span>}</div>)}
      </div>
      <div style={{padding:12,borderTop:"1px solid #1e293b",flexShrink:0,display:"flex",alignItems:"center",gap:10}}>
        {user.picture?<img src={user.picture} alt="" style={{width:32,height:32,borderRadius:"50%",flexShrink:0}}/>:<div style={{width:32,height:32,borderRadius:"50%",background:"#1e293b",display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:600,color:"#94a3b8",flexShrink:0}}>{(user.name||"G")[0].toUpperCase()}</div>}
        <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.name}</div><div style={{fontSize:10,color:"#475569",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.email}</div></div>
        <button onClick={onLogout} title="Sign out" style={{background:"none",border:"none",color:"#475569",cursor:"pointer",padding:4,borderRadius:4,transition:".15s"}} onMouseEnter={e=>e.currentTarget.style.color="#ef4444"} onMouseLeave={e=>e.currentTarget.style.color="#475569"}><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
      </div>
    </aside>

    {/* Main */}
    <main style={{flex:1,display:"flex",flexDirection:"column",minWidth:0,position:"relative",zIndex:1,marginRight:viewF&&!IS_MOBILE?fpW+"%":0,transition:viewF?"none":"margin .2s"}}>
      <div style={{padding:"10px 16px",borderBottom:"1px solid #1e293b",display:"flex",alignItems:"center",gap:10,background:"rgba(13,18,32,.8)",backdropFilter:"blur(20px)",flexShrink:0}}>
        <button onClick={()=>setSb(!sb)} style={{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",padding:4,fontSize:18,lineHeight:1}}>â˜°</button>
        <span style={{fontFamily:"'JetBrains Mono'",fontSize:11,color:mdl.c,background:mdl.c+"10",padding:"3px 8px",borderRadius:6,border:"1px solid "+mdl.c+"20",display:"flex",alignItems:"center",gap:5}}><span style={{width:5,height:5,borderRadius:"50%",background:mdl.c}}/>{mdl.nm}</span>
        {mode&&<span style={{fontSize:10,color:"#475569",background:"#111827",padding:"2px 8px",borderRadius:6,border:"1px solid #1e293b"}}>{mode.icon} {mode.label}</span>}
        {et&&<span style={{fontSize:10,color:"#a78bfa",background:"#a78bfa10",padding:"2px 8px",borderRadius:6,border:"1px solid #a78bfa20"}}>ğŸ§  Think</span>}
        <div style={{marginLeft:"auto",fontSize:11,color:"#475569",display:"flex",alignItems:"center",gap:5}}><span style={{width:5,height:5,borderRadius:"50%",background:"#34d399",animation:"pu 2s ease-in-out infinite"}}/>Online</div>
      </div>
      <div ref={chatRef} style={{flex:1,overflowY:"auto",padding:IS_MOBILE?16:24,display:"flex",flexDirection:"column",gap:16}}>
        {wel?<div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",textAlign:"center",padding:IS_MOBILE?20:40,gap:16}}>
          <div style={{width:70,height:70,borderRadius:18,background:"linear-gradient(135deg,#00f0c0,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"'JetBrains Mono'",fontWeight:700,fontSize:24,color:"#0a0e17",animation:"wp 3s ease-in-out infinite"}}>SX</div>
          <h1 style={{fontSize:IS_MOBILE?24:32,fontWeight:800,background:"linear-gradient(135deg,#e2e8f0,#94a3b8)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"}}>What can I help you with?</h1>
          <p style={{color:"#94a3b8",fontSize:13,maxWidth:480,lineHeight:1.5}}>Upload files, search the web, generate code & documents.</p>
          <div style={{display:"grid",gridTemplateColumns:IS_MOBILE?"1fr":"1fr 1fr",gap:8,marginTop:8,maxWidth:540,width:"100%"}}>{SUGS.map((s,i)=><div key={i} className="sug" onClick={()=>useSug(s.p)} style={{padding:"12px 14px",borderRadius:10,background:"#111827",border:"1px solid #1e293b",cursor:"pointer",textAlign:"left",transition:".2s"}}><div style={{fontSize:16,marginBottom:4}}>{s.icon}</div><div style={{fontSize:12,color:"#94a3b8",lineHeight:1.4}}>{s.text}</div></div>)}</div>
        </div>:<>{msgs.map((msg,i)=>{
          const ai=msg.role==="assistant";const typ=ai&&msg.content===""&&stm&&i===msgs.length-1;
          const mi2=ai&&msg.model?MODELS.find(m=>m.nm===msg.model):null;const hv=ai&&msg.versions&&msg.versions.length>1;
          return<div key={i} style={{display:"flex",gap:10,maxWidth:820,width:"100%",margin:"0 auto",flexDirection:ai?"row":"row-reverse",animation:"mi .3s ease"}}>
            {ai?<div style={{width:28,height:28,borderRadius:7,flexShrink:0,background:"linear-gradient(135deg,#00f0c0,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:700,color:"#0a0e17",alignSelf:"flex-start"}}>SX</div>:<div style={{width:28,height:28,borderRadius:7,flexShrink:0,background:"#111827",border:"1px solid #1e293b",display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:600,color:"#94a3b8",alignSelf:"flex-start"}}>You</div>}
            <div style={{maxWidth:"calc(100% - 44px)",minWidth:0}}>
              {!ai&&msg.files?.length>0&&<div style={{display:"flex",gap:6,marginBottom:6,flexWrap:"wrap"}}>{msg.files.map((f,fi)=><div key={fi} style={{borderRadius:6,overflow:"hidden",border:"1px solid #1e293b",cursor:"pointer"}} onClick={()=>{if(f.preview)setLbSrc(f.preview);}}>{f.preview?<img src={f.preview} alt="" style={{maxWidth:180,maxHeight:130,display:"block"}}/>:<div style={{padding:"6px 10px",background:"#111827",fontSize:11,color:"#94a3b8",display:"flex",alignItems:"center",gap:4}}><Ic.Fl/>{f.name}</div>}</div>)}</div>}
              <div className={ai?"mc":""} style={{padding:"12px 16px",borderRadius:12,lineHeight:1.7,fontSize:14,background:ai?"#111827":"linear-gradient(135deg,rgba(0,240,192,.06),rgba(0,240,192,.03))",border:ai?"1px solid #1e293b":"1px solid rgba(0,240,192,.15)",userSelect:"text",wordBreak:"break-word"}}>
                {typ?<div style={{display:"flex",alignItems:"center",gap:5,height:24}}>{[0,1,2].map(j=><span key={j} style={{width:6,height:6,borderRadius:"50%",background:"#00f0c0",display:"block",animation:"dotB 1.4s ease-in-out infinite "+j*.16+"s"}}/>)}</div>:ai?<MsgHtml content={msg.content} onLink={openLink} onView={f=>setViewF(f)}/>:<span style={{whiteSpace:"pre-wrap"}}>{msg.content}</span>}
              </div>
              {!ai&&msg.content&&<div style={{display:"flex",justifyContent:"flex-end",alignItems:"center",marginTop:3,gap:4}}>{msg.ts&&<span style={{fontSize:9,color:"#334155",fontFamily:"'JetBrains Mono'"}}>{new Date(msg.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>}<button className="ab" onClick={()=>navigator.clipboard.writeText(msg.content)} title="Copy"><Ic.Copy/></button></div>}
              {ai&&msg.content!==""&&!typ&&<div style={{display:"flex",alignItems:"center",gap:2,marginTop:5,flexWrap:"wrap"}}>
                {mi2&&<span style={{display:"inline-flex",alignItems:"center",gap:3,fontSize:10,color:"#475569",fontFamily:"'JetBrains Mono'",marginRight:6}}><span style={{width:4,height:4,borderRadius:"50%",background:mi2.c}}/>{mi2.nm}</span>}
                {msg.ts&&<span style={{fontSize:9,color:"#334155",fontFamily:"'JetBrains Mono'",marginRight:4}}>{new Date(msg.ts).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span>}
                <button className="ab" onClick={()=>copyM(msg.content)} title="Copy"><Ic.Copy/></button>
                <button className="ab" onClick={()=>togSpk(i,msg.content)} title={spk===i?"Stop":"Read"}>{spk===i?<Ic.Mut/>:<Ic.Spk/>}</button>
                {!stm&&<button className="ab" onClick={()=>regen(i)} title="Regenerate"><Ic.Reg/></button>}
                {hv&&<div style={{display:"flex",alignItems:"center",gap:2,marginLeft:4}}><button className="ab" onClick={()=>switchV(i,-1)}><Ic.L/></button><span style={{fontSize:9,color:"#475569",fontFamily:"'JetBrains Mono'",minWidth:28,textAlign:"center"}}>{(msg.versionIdx||0)+1}/{msg.versions.length}</span><button className="ab" onClick={()=>switchV(i,1)}><Ic.R/></button></div>}
              </div>}
            </div>
          </div>;})}</>}
        <div ref={endR}/>
      </div>
      {/* Input */}
      <div style={{padding:IS_MOBILE?"8px 12px 10px":"10px 24px 14px",background:"linear-gradient(180deg,transparent,rgba(13,18,32,.95) 20%)",flexShrink:0,position:"relative"}}>
        {showScrollBtn&&<button onClick={scrollToBottom} style={{position:"absolute",top:-44,left:"50%",transform:"translateX(-50%)",width:36,height:36,borderRadius:"50%",background:"#111827",border:"1px solid #1e293b",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 12px rgba(0,0,0,.4)",zIndex:5,transition:".15s",color:"#94a3b8"}} onMouseEnter={e=>e.currentTarget.style.borderColor="rgba(0,240,192,.3)"} onMouseLeave={e=>e.currentTarget.style.borderColor="#1e293b"}><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="6 9 12 15 18 9"/></svg></button>}
        <div style={{maxWidth:820,margin:"0 auto"}}>
          <div style={{display:"flex",gap:5,marginBottom:6,justifyContent:"center",flexWrap:"wrap"}}>
            {MODES.map((m,i)=><button key={i} className={"mc2"+(mode?.label===m.label?" on":"")} onClick={()=>setMode(mode?.label===m.label?null:m)}><span style={{fontSize:12}}>{m.icon}</span>{m.label}</button>)}
            <button className={"mc2"+(et?" on":"")} onClick={()=>setEt(!et)} style={et?{borderColor:"rgba(167,139,250,.4)",color:"#a78bfa",background:"rgba(167,139,250,.06)"}:{}}><span style={{fontSize:12}}>ğŸ§ </span>Think</button>
          </div>
          {files.length>0&&<div style={{display:"flex",gap:6,marginBottom:6,flexWrap:"wrap",justifyContent:"center"}}>{files.map((f,i)=><div key={i} style={{position:"relative",borderRadius:6,overflow:"hidden",border:"1px solid #1e293b",background:"#111827",cursor:"pointer"}} onClick={()=>{if(f.preview)setLbSrc(f.preview);}}>{f.preview?<img src={f.preview} alt="" style={{width:50,height:50,objectFit:"cover",display:"block"}}/>:<div style={{padding:"6px 20px 6px 8px",fontSize:10,color:"#94a3b8",display:"flex",alignItems:"center",gap:3}}><Ic.Fl/>{f.name.slice(0,16)}</div>}<button onClick={e=>{e.stopPropagation();setFiles(p=>p.filter((_,j)=>j!==i));}} style={{position:"absolute",top:1,right:1,width:16,height:16,borderRadius:3,background:"rgba(0,0,0,.7)",border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"#94a3b8"}}><Ic.X/></button></div>)}</div>}
          <div style={{display:"flex",gap:8,alignItems:"flex-end"}}>
            <div ref={mR} style={{position:"relative",flexShrink:0,height:BTN,display:"flex",alignItems:"center"}}>
              <button onClick={()=>setPm(!pm)} style={{width:BTN,height:BTN,borderRadius:12,background:"#111827",border:"1px solid #1e293b",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:pm?"#00f0c0":"#64748b",transition:".15s",transform:pm?"rotate(45deg)":"none"}}><Ic.Pls/></button>
              {pm&&<div className="pm"><div className="pi" onClick={()=>{fR.current?.click();setPm(false);}}><div className="pii"><Ic.Im/></div>Add files or photos</div><div className="pdv"/><div className="pi" onClick={()=>{setWs(!ws);setPm(false);}}><div className="pii"><Ic.Gl/></div>Web search<div style={{marginLeft:"auto"}}>{ws&&<Ic.Ch/>}</div></div><div className="pi" onClick={()=>{setEt(!et);setPm(false);}}><div className="pii"><Ic.Br/></div>Extended thinking<div style={{marginLeft:"auto"}}>{et&&<Ic.Ch/>}</div></div></div>}
            </div>
            <div style={{flex:1,position:"relative",display:"flex",alignItems:"flex-end"}}>
              <textarea ref={taR} className="itx" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey} onPaste={onPaste} placeholder="Ask SynthEx anything..." rows={1} style={{width:"100%",padding:"10px "+(BTN+14)+"px 10px 16px",background:"#0f1629",border:"1px solid #1e293b",borderRadius:14,color:"#e2e8f0",fontFamily:"'Outfit',sans-serif",fontSize:16,resize:"none",outline:"none",lineHeight:1.5,maxHeight:180,minHeight:BTN,transition:"border-color .2s,box-shadow .2s",overflowY:"hidden"}} onInput={e=>{e.target.style.height="auto";const sh=e.target.scrollHeight;if(sh<=130){e.target.style.height=Math.max(sh,BTN)+"px";e.target.style.overflowY="hidden";}else{e.target.style.height="130px";e.target.style.overflowY="auto";}}}/>
              <div style={{position:"absolute",right:4,bottom:4}}>
                {stm?<button className="stpb" onClick={stop} style={{width:34,height:34,borderRadius:10,background:"#ef4444",border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}><div style={{width:12,height:12,background:"white",borderRadius:2}}/></button>
                :<button className="sndb" onClick={()=>doSend()} disabled={!input.trim()&&!files.length} style={{width:34,height:34,borderRadius:10,background:"linear-gradient(135deg,#00f0c0,#34d399)",border:"none",cursor:(input.trim()||files.length)?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",opacity:(input.trim()||files.length)?1:.3,transition:".2s"}}><Ic.Snd/></button>}
              </div>
            </div>
          </div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:5,padding:"0 4px"}}><span style={{fontSize:10,color:"#475569"}}>{ws?"ğŸŒ Web":""}{ws&&et?" Â· ":""}{et?"ğŸ§  Think":""}</span><span style={{fontSize:10,fontWeight:600,fontFamily:"'JetBrains Mono'"}}>{(()=>{const l=checkLimit();if(!l.ok){const ms=l.reset-Date.now();const hrs=Math.floor(ms/3600000);const mins=Math.ceil((ms%3600000)/60000);const tStr=hrs>0?hrs+"h "+mins+"m":mins+"m";return<span style={{color:"#ef4444"}}>â³ {tStr}</span>;}const pct=l.left/l.max;const col=pct>0.5?"#00f0c0":pct>0.2?"#f59e0b":"#ef4444";return<span style={{color:col}}>{l.left}/{l.max}</span>;})()}</span><span style={{fontSize:10,color:"#475569"}}>SynthEx <span style={{color:mdl.c}}>{mdl.nm}</span></span></div>
        </div>
      </div>
    </main>
  </div>;
}

ReactDOM.createRoot(document.getElementById("root")).render(<AuthWrapper/>);

function AuthWrapper(){
  const[user,setUser]=useState(null);const[ck,setCk]=useState(true);
  useEffect(()=>{try{const d=localStorage.getItem("sx-user");if(d)setUser(JSON.parse(d));}catch{}setCk(false);},[]);
  function login(u){setUser(u);try{localStorage.setItem("sx-user",JSON.stringify(u));}catch{}}
  function logout(){setUser(null);try{localStorage.removeItem("sx-user");}catch{}}
  if(ck)return<div style={{height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"#0a0e17"}}><div style={{width:50,height:50,borderRadius:14,background:"linear-gradient(135deg,#00f0c0,#a78bfa)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"'JetBrains Mono'",fontWeight:700,fontSize:18,color:"#0a0e17",animation:"wp 2s ease-in-out infinite"}}>SX</div></div>;
  return user?<App user={user} onLogout={logout}/>:<Login onLogin={login}/>;
}
</script>
</body>
</html>
